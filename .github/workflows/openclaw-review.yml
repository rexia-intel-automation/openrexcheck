name: OpenClaw Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [ main ]

jobs:
  review:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Get PR information
        id: pr-info
        run: |
          echo "PR_NUMBER=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          echo "REPO_FULL_NAME=${{ github.repository }}" >> $GITHUB_OUTPUT
          echo "PR_TITLE=${{ github.event.pull_request.title }}" >> $GITHUB_OUTPUT

      - name: Analyze changes with OpenClaw
        id: openclaw-review
        run: |
          echo "ğŸ” Analisando cÃ³digo do PR #${{ steps.pr-info.outputs.PR_NUMBER }}"
          
          # Listar arquivos modificados
          echo "ğŸ“ Arquivos modificados:"
          git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} || true
          
          # Contar linhas alteradas
          LINES_CHANGED=$(git diff --stat ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} | tail -1 | awk '{print $4+$6}')
          echo "ğŸ“Š Linhas alteradas: $LINES_CHANGED"
          
          # Verificar se hÃ¡ testes
          HAS_TESTS=$(find . -name "*.test.*" -o -name "*.spec.*" | wc -l)
          echo "ğŸ§ª Arquivos de teste encontrados: $HAS_TESTS"
          
          # AnÃ¡lise bÃ¡sica de seguranÃ§a
          echo "ğŸ”’ Verificando seguranÃ§a..."
          # Aqui poderia usar ferramentas como npm audit, snyk, etc.
          
          # Gerar resumo da anÃ¡lise
          echo "## ğŸ“‹ Resumo da AnÃ¡lise" > review-summary.md
          echo "" >> review-summary.md
          echo "**PR:** #${{ steps.pr-info.outputs.PR_NUMBER }} - ${{ steps.pr-info.outputs.PR_TITLE }}" >> review-summary.md
          echo "" >> review-summary.md
          echo "**MÃ©tricas:**" >> review-summary.md
          echo "- ğŸ“Š Linhas alteradas: $LINES_CHANGED" >> review-summary.md
          echo "- ğŸ§ª Testes: $HAS_TESTS arquivo(s) de teste" >> review-summary.md
          echo "- ğŸ“ Arquivos modificados: $(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} | wc -l)" >> review-summary.md
          echo "" >> review-summary.md
          echo "**RecomendaÃ§Ãµes:**" >> review-summary.md
          echo "- âœ… Verificar se todos os testes passam" >> review-summary.md
          echo "- ğŸ“ Atualizar documentaÃ§Ã£o se necessÃ¡rio" >> review-summary.md
          echo "- ğŸ” Revisar mudanÃ§as em arquivos crÃ­ticos" >> review-summary.md
          echo "" >> review-summary.md
          echo "---" >> review-summary.md
          echo "*AnÃ¡lise automÃ¡tica via OpenClaw CI*" >> review-summary.md
          
          # Salvar output para prÃ³ximo passo
          echo "REVIEW_SUMMARY=$(cat review-summary.md | jq -Rs .)" >> $GITHUB_OUTPUT

      - name: Post review comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const summary = `${{ steps.openclaw-review.outputs.REVIEW_SUMMARY }}`;
            const prNumber = ${{ github.event.pull_request.number }};
            
            // Postar comentÃ¡rio no PR
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: JSON.parse(summary)
            });
            
            // Adicionar labels baseado na anÃ¡lise
            const linesChanged = parseInt('${{ steps.openclaw-review.outputs.LINES_CHANGED }}' || '0');
            if (linesChanged > 500) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                labels: ['large-pr']
              });
            }

      - name: Check for critical issues
        if: ${{ false }} # Placeholder para verificaÃ§Ãµes futuras
        run: |
          echo "ğŸ”„ Em breve: verificaÃ§Ãµes de seguranÃ§a e qualidade"
          echo "Planejado:"
          echo "- npm audit para dependÃªncias"
          echo "- ESLint para qualidade de cÃ³digo"
          echo "- TypeScript type checking"
          echo "- Test coverage report"